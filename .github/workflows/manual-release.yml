name: 手动发布

on:
  workflow_dispatch:

jobs:
  build-and-release:
    name: 构建并导出产物
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 安装 .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 6.0.x

      - name: 还原依赖
        run: dotnet restore Ra2Client.sln

      - name: 发布客户端
        run: dotnet publish RA2Client/Ra2Client.csproj --configuration Release --runtime win-x86 --self-contained false --no-restore -p:UseAppHost=true

      - name: 读取版本号
        id: version
        shell: pwsh
        run: |
          [xml]$csproj = Get-Content -Path "RA2Client/Ra2Client.csproj"
          $version = $csproj.Project.PropertyGroup | ForEach-Object { $_.Version } | Where-Object { $_ } | Select-Object -First 1
          if (-not $version) {
            throw "Version not found in RA2Client/Ra2Client.csproj"
          }
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "tag=v$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: 查找构建产物
        id: find_artifacts
        shell: pwsh
        run: |
          $workspace = $env:GITHUB_WORKSPACE
          Write-Host "工作目录：$workspace"
          $exeCandidates = Get-ChildItem -Path $workspace -Filter "RA2Client.exe" -Recurse -ErrorAction SilentlyContinue | Sort-Object FullName
          if ($exeCandidates.Count -eq 0) {
            Write-Warning "未在工作目录内找到 RA2Client.exe"
            "found=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            exit 0
          }

          Write-Host "找到以下候选文件："
          $exeCandidates | ForEach-Object {
            Write-Host (" - {0}" -f $_.FullName)
          }

          $preferred = $exeCandidates | Where-Object { $_.FullName -match "publish" } | Select-Object -First 1
          if (-not $preferred) {
            $preferred = $exeCandidates | Select-Object -First 1
          }

          $targetDir = $preferred.Directory.FullName
          Write-Host "选定发布目录：$targetDir"

          "found=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "publish-dir=$targetDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: 检查发布目录
        if: ${{ steps.find_artifacts.outputs.found == 'true' }}
        shell: pwsh
        env:
          TARGET_DIR: ${{ steps.find_artifacts.outputs.publish-dir }}
        run: |
          Write-Host "发布目录结构："
          Get-ChildItem -Path $env:TARGET_DIR -Recurse | ForEach-Object {
            "{0}`t{1}" -f $_.FullName, $_.Length
          }

      - name: 上传发布产物便于检查
        if: ${{ steps.find_artifacts.outputs.found == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: publish-folder
          path: ${{ steps.find_artifacts.outputs.publish-dir }}

      # - name: 创建草稿发布
      #   uses: softprops/action-gh-release@v2
      #   with:
      #     draft: true
      #     tag_name: ${{ steps.version.outputs.tag }}
      #     name: 重聚未来 ${{ steps.version.outputs.version }}
      #     body: |
      #       ## 重聚未来 ${{ steps.version.outputs.version }}
      #
      #       > 请将以下占位符替换为本次更新的具体内容。
      #
      #       ### 更新内容
      #       - TODO：在此填写主要更新说明
      #
      #       ### 构建信息
      #       - 版本号：${{ steps.version.outputs.version }}
      #       - 自动构建：${{ github.workflow }} #${{ github.run_number }}
      #       - 提交哈希：${{ github.sha }}
      #
      #
      #       **压缩包为.exe文件的压缩，节省下载流量**
      #
      #     files: |
      #       artifacts/重聚未来-${{ steps.version.outputs.version }}.exe
      #       artifacts/重聚未来-${{ steps.version.outputs.version }}.zip
