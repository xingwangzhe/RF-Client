name: 手动发布

on:
  workflow_dispatch:

jobs:
  build-win-x64:
    name: 构建 win-x64 产物
    runs-on: windows-latest
    permissions:
      contents: read
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 安装 .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 6.0.x

      - name: 还原依赖 (win-x64)
        run: dotnet restore Ra2Client.sln --runtime win-x64

      - name: 发布客户端 (win-x64)
        run: |
          dotnet publish RA2Client/Ra2Client.csproj ^
            --configuration Release ^
            --runtime win-x64 ^
            --self-contained false ^
            --no-restore ^
            -p:UseAppHost=true ^
            -p:IsPublishable=true ^
            -p:PublishDir="publish/win-x64/"

      - name: 读取版本号
        id: version
        shell: pwsh
        run: |
          [xml]$csproj = Get-Content -Path "RA2Client/Ra2Client.csproj"
          $version = $csproj.Project.PropertyGroup | ForEach-Object { $_.Version } | Where-Object { $_ } | Select-Object -First 1
          if (-not $version) {
            throw "Version not found in RA2Client/Ra2Client.csproj"
          }
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "tag=v$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: 安装 Inno Setup (win-x64)
        run: choco install innosetup --no-progress -y

      - name: 生成安装程序 (win-x64)
        shell: pwsh
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          $publishDir = Join-Path $PWD "publish/win-x64"
          if (-not (Test-Path $publishDir)) {
            throw "未找到发布目录：$publishDir"
          }

          $issPath = Join-Path $PWD "installer-win-x64.iss"
          @"
          [Setup]
          AppName=重聚未来
          AppVersion={#Version}
          DefaultDirName={pf64}\重聚未来
          DefaultGroupName=重聚未来
          OutputBaseFilename=重聚未来-{#Version}-win-x64-setup
          Compression=lzma
          SolidCompression=yes

          [Files]
          Source: "{#SourceDir}\*"; DestDir: "{app}"; Flags: recursesubdirs ignoreversion

          [Icons]
          Name: "{group}\重聚未来"; Filename: "{app}\RA2Client.exe"
          Name: "{commondesktop}\重聚未来"; Filename: "{app}\RA2Client.exe"; Tasks: desktopicon

          [Tasks]
          Name: "desktopicon"; Description: "在桌面创建快捷方式"; GroupDescription: "其他任务："
          "@ | Set-Content -Path $issPath -Encoding UTF8

          & 'C:\Program Files (x86)\Inno Setup 6\ISCC.exe' `
            /DVersion=$env:VERSION `
            /DSourceDir=$publishDir `
            $issPath

          $artifacts = Join-Path $PWD "artifacts"
          New-Item -ItemType Directory -Path $artifacts -Force | Out-Null
          Get-ChildItem -Path $PWD -Filter "重聚未来-$env:VERSION-win-x64-setup.exe" -Recurse | ForEach-Object {
            Copy-Item $_.FullName -Destination (Join-Path $artifacts $_.Name) -Force
          }

      - name: 打包 win-x64 目录
        shell: pwsh
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          $publishDir = Join-Path $PWD "publish/win-x64"
          if (-not (Test-Path $publishDir)) {
            throw "未找到发布目录：$publishDir"
          }

          $artifacts = Join-Path $PWD "artifacts"
          New-Item -ItemType Directory -Path $artifacts -Force | Out-Null

          $zipPath = Join-Path $artifacts "重聚未来-$env:VERSION-win-x64.zip"
          Compress-Archive -Path (Join-Path $publishDir '*') -DestinationPath $zipPath -Force

      - name: 上传构建产物 (win-x64)
        uses: actions/upload-artifact@v4
        with:
          name: release-files-win-x64
          path: artifacts/

  build-win-arm64:
    name: 构建 win-arm64 产物
    runs-on: windows-latest
    permissions:
      contents: read
    needs: build-win-x64
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 安装 .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 6.0.x

      - name: 还原依赖 (win-arm64)
        run: dotnet restore Ra2Client.sln --runtime win-arm64

      - name: 发布客户端 (win-arm64)
        run: |
          dotnet publish RA2Client/Ra2Client.csproj ^
            --configuration Release ^
            --runtime win-arm64 ^
            --self-contained false ^
            --no-restore ^
            -p:UseAppHost=true ^
            -p:IsPublishable=true ^
            -p:PublishDir="publish/win-arm64/"

      - name: 安装 Inno Setup (win-arm64)
        run: choco install innosetup --no-progress -y

      - name: 生成安装程序 (win-arm64)
        shell: pwsh
        env:
          VERSION: ${{ needs.build-win-x64.outputs.version }}
        run: |
          $publishDir = Join-Path $PWD "publish/win-arm64"
          if (-not (Test-Path $publishDir)) {
            throw "未找到发布目录：$publishDir"
          }

          $issPath = Join-Path $PWD "installer-win-arm64.iss"
          @"
          [Setup]
          AppName=重聚未来
          AppVersion={#Version}
          DefaultDirName={pf}\重聚未来
          DefaultGroupName=重聚未来
          OutputBaseFilename=重聚未来-{#Version}-win-arm64-setup
          Compression=lzma
          SolidCompression=yes

          [Files]
          Source: "{#SourceDir}\*"; DestDir: "{app}"; Flags: recursesubdirs ignoreversion

          [Icons]
          Name: "{group}\重聚未来"; Filename: "{app}\RA2Client.exe"
          Name: "{commondesktop}\重聚未来"; Filename: "{app}\RA2Client.exe"; Tasks: desktopicon

          [Tasks]
          Name: "desktopicon"; Description: "在桌面创建快捷方式"; GroupDescription: "其他任务："
          "@ | Set-Content -Path $issPath -Encoding UTF8

          & 'C:\Program Files (x86)\Inno Setup 6\ISCC.exe' `
            /DVersion=$env:VERSION `
            /DSourceDir=$publishDir `
            $issPath

          $artifacts = Join-Path $PWD "artifacts"
          New-Item -ItemType Directory -Path $artifacts -Force | Out-Null
          Get-ChildItem -Path $PWD -Filter "重聚未来-$env:VERSION-win-arm64-setup.exe" -Recurse | ForEach-Object {
            Copy-Item $_.FullName -Destination (Join-Path $artifacts $_.Name) -Force
          }

      - name: 打包 win-arm64 目录
        shell: pwsh
        env:
          VERSION: ${{ needs.build-win-x64.outputs.version }}
        run: |
          $publishDir = Join-Path $PWD "publish/win-arm64"
          if (-not (Test-Path $publishDir)) {
            throw "未找到发布目录：$publishDir"
          }

          $artifacts = Join-Path $PWD "artifacts"
          New-Item -ItemType Directory -Path $artifacts -Force | Out-Null

          $zipPath = Join-Path $artifacts "重聚未来-$env:VERSION-win-arm64.zip"
          Compress-Archive -Path (Join-Path $publishDir '*') -DestinationPath $zipPath -Force

      - name: 上传构建产物 (win-arm64)
        uses: actions/upload-artifact@v4
        with:
          name: release-files-win-arm64
          path: artifacts/

  draft-release:
    name: 创建草稿发布
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: [build-win-x64, build-win-arm64]
    steps:
      - name: 下载所有构建产物
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: 创建草稿发布
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          tag_name: ${{ needs.build-win-x64.outputs.tag }}
          name: 重聚未来 ${{ needs.build-win-x64.outputs.version }} 多平台预览
          body: |
            ## 重聚未来 ${{ needs.build-win-x64.outputs.version }} 多平台构建

            > 请将以下占位符替换为本次更新的具体内容。

            ### 更新内容
            - TODO：在此填写主要更新说明

            ### 构建信息
            - 版本号：${{ needs.build-win-x64.outputs.version }}
            - 自动构建：${{ github.workflow }} #${{ github.run_number }}
            - 提交哈希：${{ github.sha }}
            - win-x64：适用于常规 64 位 Windows 设备
            - win-arm64：适用于基于 ARM 的 Windows 设备（如 Surface Pro X）


            **每个安装包为对应平台的 Inno Setup 安装程序，可直接运行安装；压缩包为免安装版完整目录，可解压后运行 RA2Client.exe。**

          files: |
            artifacts/release-files-win-x64/重聚未来-${{ needs.build-win-x64.outputs.version }}-win-x64.zip
            artifacts/release-files-win-arm64/重聚未来-${{ needs.build-win-x64.outputs.version }}-win-arm64.zip
            artifacts/release-files-win-x64/重聚未来-${{ needs.build-win-x64.outputs.version }}-win-x64-setup.exe
            artifacts/release-files-win-arm64/重聚未来-${{ needs.build-win-x64.outputs.version }}-win-arm64-setup.exe
